{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["// Adapted from https://gist.github.com/flpvsk/047140b31c968001dc563998f7440cc1\n\n/* global AudioWorkletProcessor */\n/* global registerProcessor */\n\nclass RecorderWorkletProcessor extends AudioWorkletProcessor {\n  static get parameterDescriptors() {\n    return [\n      {\n        name: 'isRecording',\n        defaultValue: 0,\n      },\n    ];\n  }\n\n  constructor(options) {\n    super();\n    this._numChannels = options.processorOptions.numChannels || 1;\n    this._bufferSize = 2048;\n    this._buffers = Array.from(\n      { length: this._numChannels },\n      () => new Float32Array(this._bufferSize),\n    );\n    // this._buffer = new Float32Array(this._bufferSize);\n    this._initBuffer();\n  }\n\n  _initBuffer() {\n    this._bytesWritten = 0;\n  }\n\n  _isBufferEmpty() {\n    return this._bytesWritten === 0;\n  }\n\n  _isBufferFull() {\n    return this._bytesWritten === this._bufferSize;\n  }\n\n  _appendToBuffer(value, channel) {\n    if (this._isBufferFull()) {\n      this._flush();\n    }\n\n    if (channel < this._numChannels) {\n      this._buffers[channel][this._bytesWritten] = value;\n    }\n\n    if (channel == 0) {\n      this._bytesWritten += 1;\n    }\n  }\n\n  _flush() {\n    let buffers = this._buffers;\n    for (let buffer in buffers) {\n      if (this._bytesWritten < this._bufferSize) {\n        buffer = buffer.slice(0, this._bytesWritten);\n      }\n    }\n\n    this.port.postMessage({\n      eventType: 'data',\n      audioBuffer: buffers,\n    });\n\n    this._initBuffer();\n  }\n\n  _recordingStopped() {\n    this.port.postMessage({\n      eventType: 'stop',\n    });\n  }\n\n  _rms(buffer) {\n    let sqr = buffer.map((x) => x * x);\n    let sum = sqr.reduce((a, b) => a + b);\n    let mean = sum / buffer.length;\n    return Math.sqrt(mean);\n  }\n\n  process(inputs, outputs, parameters) {\n    const isRecordingValues = parameters.isRecording;\n    let input = inputs[0];\n    let output = outputs[0];\n    for (let channel = 0; channel < input.length; channel++) {\n      output[channel].set(input[channel]);\n    }\n\n    for (let dataIndex = 0; dataIndex < output[0].length; dataIndex++) {\n      const shouldRecord =\n        (isRecordingValues.length > 1\n          ? isRecordingValues[dataIndex]\n          : isRecordingValues[0]) === 1;\n\n      if (!shouldRecord && !this._isBufferEmpty()) {\n        this._flush();\n        this._recordingStopped();\n        return false;\n      }\n\n      if (shouldRecord) {\n        for (let channel = 0; channel < input.length; channel++) {\n          this._appendToBuffer(outputs[0][channel][dataIndex], channel);\n        }\n      }\n    }\n\n    return true;\n  }\n}\n\nregisterProcessor('recorder-worklet', RecorderWorkletProcessor);\n"],"names":[],"mappings":"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"}